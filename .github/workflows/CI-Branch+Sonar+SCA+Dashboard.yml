# name: CI-Branch + SonarCloud + SCA + Dashboard

# on:
#   push:
#     branches: 
#     - angeline/**
#     - thengyi/**
#     - ralph/**
#     - nyunt/**
#     - danglam/**
#     - sara*/**
#     - andrew/**
#     - main

#   pull_request:
#   workflow_dispatch:

# env:
#   AZURE_WEBAPP_NAME: in5nite
#   DOTNET_VERSION: '8.0.x'
#   PROJECT_PATH: './ADWebApplication/ADWebApplication.csproj'
#   SKIP_KEYVAULT_IN_TESTS: "true"



# jobs:
#   # =========================================================
#   # JOB 1: CI + SonarCloud + OWASP DEPENDENCY-CHECK
#   # =========================================================
#   build-and-sast-sca-scan:
#     permissions:
#       contents: write
#       pages: write
#       id-token: write
#     runs-on: ubuntu-latest

#     steps:
#       # ---- Checkout ----
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       # ---- Setup .NET ----
#       - name: Setup .NET
#         uses: actions/setup-dotnet@v4
#         with:
#           dotnet-version: ${{ env.DOTNET_VERSION }}

#       # ---- Setup Node.js for JavaScript tests ----
#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'

#       # ---- Install SonarScanner ----
#       - name: Install SonarScanner
#         run: dotnet tool install --global dotnet-sonarscanner

#       # ---- SonarCloud Begin ----
#       - name: SonarCloud Begin
#         env:
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#         run: |
#           dotnet sonarscanner begin \
#             /k:"GDipSA-Team-5_AD-Project" \
#             /o:"gdipsa-team-5" \
#             /d:sonar.host.url="https://sonarcloud.io" \
#             /d:sonar.projectBaseDir="$GITHUB_WORKSPACE" \
#             /d:sonar.sources="ADWebApplication" \
#             /d:sonar.tests="ADWebApplication.Tests" \
#             /d:sonar.javascript.lcov.reportPaths="ADWebApplication.Tests/JavaScript/coverage/lcov.info" \
#             /d:sonar.cs.opencover.reportsPaths="TestResults/**/coverage.opencover.xml" \
#             /d:sonar.cs.vstest.reportsPaths="TestResults/**/*.trx" \
#             /d:sonar.coverage.exclusions="**/Program.cs,**/Migrations/**,**/wwwroot/lib/**,**/*.min.js,**/wwwroot/js/collector-dashboard.js,**/Models/Entities/**,**/Models/DTOs/**" \
#             /d:sonar.exclusions="**/wwwroot/lib/**,**/*.min.js" \
#             /d:sonar.test.inclusions="**/*.test.js" \
#             /d:sonar.verbose=true

#       # ---- Restore & Build main project ----
#       - name: Restore Main Project
#         run: dotnet restore ${{ env.PROJECT_PATH }}

#       - name: Build Main Project
#         run: dotnet build ${{ env.PROJECT_PATH }} --no-restore

#       # ---- Build Test Project ----
#       - name: Build Test Project
#         run: dotnet build ./ADWebApplication.Tests/ADWebApplication.Tests.csproj

#       # ---- Run .NET Tests with Coverage ----
#       - name: Test with Coverage
#         run: |
#           dotnet test ./ADWebApplication.Tests/ADWebApplication.Tests.csproj \
#             --collect:"XPlat Code Coverage" \
#             --settings coverlet.runsettings \
#             --results-directory ./TestResults \
#             --logger "trx;LogFileName=test-results.trx"

#       - name: Debug coverage files
#         run: find TestResults -name "coverage.opencover.xml" -o -name "*.trx"

#       # ---- Install JavaScript test dependencies ----
#       - name: Install JavaScript dependencies
#         run: |
#           cd ADWebApplication.Tests/JavaScript
#           npm install --ignore-scripts
#           cd ../..

#       # ---- Run JavaScript Tests with Coverage ----
#       - name: Run JavaScript Tests
#         run: |
#           cd ADWebApplication.Tests/JavaScript
#           npm test -- --coverage
#           cd ../..

#       - name: Debug JavaScript coverage files
#         run: find ADWebApplication.Tests/JavaScript/coverage -type f

#       # ---- SonarCloud End ----
#       - name: SonarCloud End
#         env:
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#         run: dotnet sonarscanner end

#       # ---- Extract SonarCloud Metrics ----
#       - name: Extract SonarCloud Metrics
#         id: sonar_metrics
#         env:
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#         run: |
#           sleep 10  # Wait for SonarCloud to process
          
#           # Fetch metrics from SonarCloud API
#           METRICS=$(curl -s -u "$SONAR_TOKEN:" \
#             "https://sonarcloud.io/api/measures/component?component=GDipSA-Team-5_AD-Project&metricKeys=bugs,vulnerabilities,code_smells,security_hotspots,coverage,duplicated_lines_density,ncloc")
          
#           echo "$METRICS" > sonar-metrics.json
          
#           # Extract specific values
#           BUGS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="bugs") | .value // "0"')
#           VULNERABILITIES=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="vulnerabilities") | .value // "0"')
#           CODE_SMELLS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="code_smells") | .value // "0"')
#           SECURITY_HOTSPOTS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="security_hotspots") | .value // "0"')
#           COVERAGE=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="coverage") | .value // "0"')
#           DUPLICATIONS=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="duplicated_lines_density") | .value // "0"')
#           LINES_OF_CODE=$(echo "$METRICS" | jq -r '.component.measures[] | select(.metric=="ncloc") | .value // "0"')
          
#           echo "bugs=$BUGS" >> $GITHUB_OUTPUT
#           echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
#           echo "code_smells=$CODE_SMELLS" >> $GITHUB_OUTPUT
#           echo "security_hotspots=$SECURITY_HOTSPOTS" >> $GITHUB_OUTPUT
#           echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
#           echo "duplications=$DUPLICATIONS" >> $GITHUB_OUTPUT
#           echo "lines_of_code=$LINES_OF_CODE" >> $GITHUB_OUTPUT

#       # ---- SonarCloud Quality Gate Check ----
#       - name: SonarCloud Quality Gate check
#         uses: SonarSource/sonarqube-quality-gate-action@v1.2.0
#         with:
#           scanMetadataReportFile: .sonarqube/out/.sonar/report-task.txt
#         env:
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#           SONAR_HOST_URL: "https://sonarcloud.io"

#       # ---- Upload Sonar Artifacts ----
#       - name: Upload SonarCloud artifacts
#         uses: actions/upload-artifact@v4
#         with:
#           name: sonarcloud-artifacts
#           path: |
#             .sonarqube/out
#             TestResults/**/coverage.opencover.xml
#             ADWebApplication.Tests/JavaScript/coverage/
#             sonar-metrics.json

#       # ---- OWASP Dependency-Check ----
#       - name: Run OWASP Dependency-Check SCA
#         uses: dependency-check/Dependency-Check_Action@1e54355a8b4c8abaa8cc7d0b70aa655a3bb15a6c
#         with:
#           project: ADWebApplication
#           path: .
#           format: ALL
#           out: ./dependency-check-report
#           args: >
#             --failOnCVSS 12
#             --suppression dependency-check-suppressions.xml
#             --exclude '**/test/**'

#       # ---- Parse Dependency Check Results ----
#       - name: Parse Dependency Check Results
#         id: dependency_check
#         run: |
#           if [ -f "./dependency-check-report/dependency-check-report.json" ]; then
#             CRITICAL=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="CRITICAL")] | length' ./dependency-check-report/dependency-check-report.json)
#             HIGH=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="HIGH")] | length' ./dependency-check-report/dependency-check-report.json)
#             MEDIUM=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="MEDIUM")] | length' ./dependency-check-report/dependency-check-report.json)
#             LOW=$(jq '[.dependencies[].vulnerabilities[]? | select(.severity=="LOW")] | length' ./dependency-check-report/dependency-check-report.json)
#             TOTAL=$(jq '[.dependencies[].vulnerabilities[]?] | length' ./dependency-check-report/dependency-check-report.json)
            
#             echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
#             echo "high=$HIGH" >> $GITHUB_OUTPUT
#             echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
#             echo "low=$LOW" >> $GITHUB_OUTPUT
#             echo "total=$TOTAL" >> $GITHUB_OUTPUT
#           else
#             echo "critical=0" >> $GITHUB_OUTPUT
#             echo "high=0" >> $GITHUB_OUTPUT
#             echo "medium=0" >> $GITHUB_OUTPUT
#             echo "low=0" >> $GITHUB_OUTPUT
#             echo "total=0" >> $GITHUB_OUTPUT
#           fi

#       - name: Upload Dependency-Check report
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: dependency-check-report
#           path: ./dependency-check-report

#       # ---- Save Scan Metadata ----
#       - name: Save Scan Metadata
#         run: |
#           mkdir -p scan-data
#           cat > scan-data/sast-sca-metadata.json << EOF
#           {
#             "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
#             "run_id": "${{ github.run_id }}",
#             "run_number": "${{ github.run_number }}",
#             "branch": "${{ github.ref_name }}",
#             "commit": "${{ github.sha }}",
#             "sonarcloud": {
#               "bugs": "${{ steps.sonar_metrics.outputs.bugs }}",
#               "vulnerabilities": "${{ steps.sonar_metrics.outputs.vulnerabilities }}",
#               "code_smells": "${{ steps.sonar_metrics.outputs.code_smells }}",
#               "security_hotspots": "${{ steps.sonar_metrics.outputs.security_hotspots }}",
#               "coverage": "${{ steps.sonar_metrics.outputs.coverage }}",
#               "duplications": "${{ steps.sonar_metrics.outputs.duplications }}",
#               "lines_of_code": "${{ steps.sonar_metrics.outputs.lines_of_code }}"
#             },
#             "dependency_check": {
#               "critical": "${{ steps.dependency_check.outputs.critical }}",
#               "high": "${{ steps.dependency_check.outputs.high }}",
#               "medium": "${{ steps.dependency_check.outputs.medium }}",
#               "low": "${{ steps.dependency_check.outputs.low }}",
#               "total": "${{ steps.dependency_check.outputs.total }}"
#             }
#           }
#           EOF

#       - name: Upload Scan Metadata
#         uses: actions/upload-artifact@v4
#         with:
#           name: sast-sca-metadata
#           path: scan-data/

# # =========================================================
# # JOB 2: OWASP ZAP Scan
# # =========================================================
#   dast-scan:
#     needs: build-and-sast-sca-scan
#     runs-on: ubuntu-latest

#     steps:
#       # ---- Checkout code ----
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # ---- Setup .NET ----
#       - name: Setup .NET
#         uses: actions/setup-dotnet@v4
#         with:
#           dotnet-version: ${{ env.DOTNET_VERSION }}

#       # ---- Publish app locally ----
#       - name: Publish App
#         run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --output publish

#       # ---- Start app locally in the background ----
#       - name: Run App Locally
#         env:
#           SKIP_KEYVAULT_IN_TESTS: "true"
#           ASPNETCORE_ENVIRONMENT: "Development"
#         run: |
#           nohup dotnet publish/ADWebApplication.dll &
#           echo "Waiting for app to start..."
          
#           timeout=60
#           elapsed=0
#           until curl -s http://localhost:5000 > /dev/null || [ $elapsed -eq $timeout ]; do
#             echo "Waiting for app to start... ($elapsed/$timeout seconds)"
#             sleep 2
#             elapsed=$((elapsed + 2))
#           done
          
#           if [ $elapsed -eq $timeout ]; then
#             echo "App failed to start within $timeout seconds"
#             cat nohup.out
#             exit 1
#           fi
          
#           echo "App is running!"

#       # ---- Run ZAP Baseline Scan ----
#       - name: Run OWASP ZAP Baseline Scan
#         uses: zaproxy/action-baseline@4ea3deb659d9a669dc5e5c10c49a423e8bb41420
#         with:
#           target: 'http://localhost:5000'
#           fail_action: false
#           artifact_name: zap-report
#           cmd_options: >
#             -J report_json.json
#             -r report_html.html
#           allow_issue_writing: false

#       # ---- Parse ZAP Results ----
#       - name: Parse ZAP Results
#         id: zap_results
#         run: |
#           if [ -f "report_json.json" ]; then
#             HIGH=$(jq '[.site[].alerts[]? | select(.riskcode=="3")] | length' report_json.json || echo "0")
#             MEDIUM=$(jq '[.site[].alerts[]? | select(.riskcode=="2")] | length' report_json.json || echo "0")
#             LOW=$(jq '[.site[].alerts[]? | select(.riskcode=="1")] | length' report_json.json || echo "0")
#             INFO=$(jq '[.site[].alerts[]? | select(.riskcode=="0")] | length' report_json.json || echo "0")
#             TOTAL=$(jq '[.site[].alerts[]?] | length' report_json.json || echo "0")
            
#             echo "high=$HIGH" >> $GITHUB_OUTPUT
#             echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
#             echo "low=$LOW" >> $GITHUB_OUTPUT
#             echo "info=$INFO" >> $GITHUB_OUTPUT
#             echo "total=$TOTAL" >> $GITHUB_OUTPUT
#           else
#             echo "high=0" >> $GITHUB_OUTPUT
#             echo "medium=0" >> $GITHUB_OUTPUT
#             echo "low=0" >> $GITHUB_OUTPUT
#             echo "info=0" >> $GITHUB_OUTPUT
#             echo "total=0" >> $GITHUB_OUTPUT
#           fi

#       # ---- Save ZAP Metadata ----
#       - name: Save ZAP Metadata
#         run: |
#           mkdir -p scan-data
#           cat > scan-data/zap-metadata.json << EOF
#           {
#             "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
#             "run_id": "${{ github.run_id }}",
#             "run_number": "${{ github.run_number }}",
#             "branch": "${{ github.ref_name }}",
#             "commit": "${{ github.sha }}",
#             "zap": {
#               "high": "${{ steps.zap_results.outputs.high }}",
#               "medium": "${{ steps.zap_results.outputs.medium }}",
#               "low": "${{ steps.zap_results.outputs.low }}",
#               "info": "${{ steps.zap_results.outputs.info }}",
#               "total": "${{ steps.zap_results.outputs.total }}"
#             }
#           }
#           EOF

#       - name: Upload ZAP Metadata
#         uses: actions/upload-artifact@v4
#         with:
#           name: zap-metadata
#           path: scan-data/

# # =========================================================
# # JOB 3: Generate Dashboard
# # =========================================================
#   generate-dashboard:
#     needs: [build-and-sast-sca-scan, dast-scan]
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Download SAST/SCA Metadata
#         uses: actions/download-artifact@v4
#         with:
#           name: sast-sca-metadata
#           path: scan-data/

#       - name: Download ZAP Metadata
#         uses: actions/download-artifact@v4
#         with:
#           name: zap-metadata
#           path: scan-data/

#       - name: Download Dependency Check Report
#         uses: actions/download-artifact@v4
#         with:
#           name: dependency-check-report
#           path: dependency-check-report/

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '20'

#       - name: Generate Dashboard HTML
#         run: |
#           mkdir -p dashboard
#           node .github/scripts/generate-dashboard.js

#       - name: Copy Reports to Dashboard
#         run: |
#           mkdir -p dashboard/reports
#           cp -r dependency-check-report/* dashboard/reports/ || true
#           cp report_*.html dashboard/reports/ 2>/dev/null || true
#           cp report_*.json dashboard/reports/ 2>/dev/null || true

#       - name: Setup Pages
#         uses: actions/configure-pages@v4

#       - name: Upload Dashboard Artifact
#         uses: actions/upload-pages-artifact@v3
#         with:
#           path: ./dashboard

#       - name: Deploy to GitHub Pages
#         id: deployment
#         uses: actions/deploy-pages@v4
