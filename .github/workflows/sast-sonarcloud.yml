name: CI with SonarCloud + SCA

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ADWebApplication

    steps:
      # Step 1: Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # REQUIRED for SonarCloud

      # Step 2: Set up .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      # Step 3: Install SonarScanner for .NET
      - name: Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner

      # Step 4: Begin SonarCloud analysis
      - name: SonarCloud Begin
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: >
          dotnet sonarscanner begin
          /k:"GDipSA-Team-5_AD-Project"
          /o:"gdipsa-team-5"
          /d:sonar.host.url="https://sonarcloud.io"
          /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"
          /d:sonar.coverage.exclusions="**/Program.cs"

      # Step 5: Restore dependencies
      - name: Restore
        run: dotnet restore

      # Step 6: Build
      - name: Build
        run: dotnet build --no-restore

      # Step 7: Test with coverage
      - name: Test
        run: >
          dotnet test
          --no-build
          /p:CollectCoverage=true
          /p:CoverletOutputFormat=opencover
          /p:CoverletOutput=./coverage.opencover.xml

      # Step 8a: End SonarCloud analysis
      - name: SonarCloud End
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end
      
      # Step 8b: Upload SonarCloud artifacts
      - name: Upload SonarCloud scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sonarcloud-artifacts
          path: |
            ADWebApplication/.sonarqube/out
            ADWebApplication/coverage.opencover.xml

      # Step 9: Quality Gate enforcement
      - name: SonarCloud Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1
        with:
          scanMetadataReportFile: ADWebApplication/.sonarqube/out/.sonar/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Step 10: OWASP Dependency-Check SCA
      - name: Run OWASP Dependency-Check SCA
        uses: dependency-check/Dependency-Check_Action@v1.1.0
        with:
          project: ADWebApplication
          path: .
          format: HTML,XML
          out: ./dependency-check-report
          args: --failOnCVSS 7

      - name: Upload Dependency-Check report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: ./dependency-check-report