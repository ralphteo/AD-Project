name: CI-dotNet

on:
  push:
    branches:
      - main 
  pull_request:
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_PATH: './ADWebApplication/ADWebApplication.csproj'
  SKIP_KEYVAULT_IN_TESTS: "true"

# =========================================================
# JOB 1: SAST + SCA (SonarCloud + Snyk)
# =========================================================
jobs:
  build-and-sast-sca-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      security-events: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ---------------- SonarCloud ----------------
      - name: Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Sonar Begin
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner begin \
            /k:"GDipSA-Team-5_AD-Project" \
            /o:"gdipsa-team-5" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.opencover.reportsPaths="TestResults/**/coverage.opencover.xml" \
            /d:sonar.exclusions="**/.github/workflows/*.yml" \
            /d:sonar.coverage.exclusions="**/Models/**,**/ViewModels/**,**/*VM.cs,**/scripts/**,**/wwwroot/**,**/Dockerfile,**/Program.cs"
      
      - name: Restore & Build
        run: |
          dotnet restore ${{ env.PROJECT_PATH }}
          dotnet build ${{ env.PROJECT_PATH }} --no-restore

      - name: Test with Coverage
        run: |
          dotnet test ./ADWebApplication.Tests/ADWebApplication.Tests.csproj \
            --collect:"XPlat Code Coverage" \
            --settings coverlet.runsettings \
            --results-directory ./TestResults

      - name: Sonar End
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end

      # ---------------- Snyk .NET Dependency Scan ----------------
      - name: Install Snyk CLI
        run: npm install -g snyk --ignore-scripts

      - name: Authenticate Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth "$SNYK_TOKEN"

      - name: Run Snyk Test
        working-directory: ADWebApplication
        run: snyk test --severity-threshold=high --sarif-file-output=../snyk-dotnet.sarif
      
      - name: Upload Snyk SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: snyk-dotnet.sarif

      - name: Parse Snyk Results
        id: snyk_results
        run: |
          if [ -f snyk-dotnet.sarif ]; then
            HIGH=$(jq '[.runs[].results[]? | select(.level=="error")] | length' snyk-dotnet.sarif)
            MEDIUM=$(jq '[.runs[].results[]? | select(.level=="warning")] | length' snyk-dotnet.sarif)
            LOW=$(jq '[.runs[].results[]? | select(.level=="note")] | length' snyk-dotnet.sarif)
            TOTAL=$(jq '[.runs[].results[]?] | length' snyk-dotnet.sarif)
          else
            HIGH=0; MEDIUM=0; LOW=0; TOTAL=0
          fi
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: docker build -t in5nite-dotnet:snyk ./ADWebApplication

      - name: Snyk Container Scan
        run: |
          snyk container test in5nite-dotnet:snyk \
            --severity-threshold=high \
            --sarif-file-output=snyk-container.sarif

      - name: Upload Container SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: snyk-container.sarif

# =========================================================
# JOB 2: DAST
# =========================================================
  dast-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Publish App
        run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --output publish

      - name: Run App Locally
        run: |
          ASPNETCORE_URLS=http://localhost:5000 nohup dotnet publish/ADWebApplication.dll &
          echo "Waiting for app to start..."
          until curl -s http://localhost:5000 > /dev/null; do
            sleep 2
          done
          echo "App is running!"

      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@4ea3deb659d9a669dc5e5c10c49a423e8bb41420
        with:
          target: 'http://localhost:5000'
          fail_action: false
          artifact_name: zap-report
          cmd_options: >
            -J report_json.json
            -r report_html.html
          allow_issue_writing: false

      # ZAP Scan ML Service
      - name: ZAP Scan ML Service
        uses: zaproxy/action-baseline@4ea3deb659d9a669dc5e5c10c49a423e8bb41420
        with:
          target: 'https://in5nite-ml-fdcycfe6gkfnhdg2.southeastasia-01.azurewebsites.net'
          cmd_options: '-J zap-ml.json'
          fail_action: false
          allow_issue_writing: false

      - name: Copy ZAP reports
        run: |
          # DOTNET
          if [ -f report_json.json ]; then
            mv report_json.json zap.json
          elif [ -f /zap/wrk/report_json.json ]; then
            sudo mv /zap/wrk/report_json.json zap.json
          else
            echo '{"site":[{"alerts":[]}]}' > zap.json
          fi

          # ML
          if [ -f /zap/wrk/zap-ml.json ]; then
            sudo mv /zap/wrk/zap-ml.json zap-ml.json
          elif [ ! -f zap-ml.json ]; then
            echo '{"site":[{"alerts":[]}]}' > zap-ml.json
          fi

      - name: Parse ZAP (Aggregate .NET + ML)
        id: zap
        run: |

          # ---------------- DOTNET ----------------
          if [ -f zap.json ]; then
            HIGH_DOTNET=$(jq '[.site[].alerts[]? | select(.riskcode=="3") | .instances[]?] | length' zap.json)
            MEDIUM_DOTNET=$(jq '[.site[].alerts[]? | select(.riskcode=="2") | .instances[]?] | length' zap.json)
            LOW_DOTNET=$(jq '[.site[].alerts[]? | select(.riskcode=="1") | .instances[]?] | length' zap.json)
          else
            HIGH_DOTNET=0; MEDIUM_DOTNET=0; LOW_DOTNET=0
          fi

          # ---------------- ML ----------------
          if [ -f zap-ml.json ]; then
            HIGH_ML=$(jq '[.site[].alerts[]? | select(.riskcode=="3") | .instances[]?] | length' zap-ml.json)
            MEDIUM_ML=$(jq '[.site[].alerts[]? | select(.riskcode=="2") | .instances[]?] | length' zap-ml.json)
            LOW_ML=$(jq '[.site[].alerts[]? | select(.riskcode=="1") | .instances[]?] | length' zap-ml.json)
          else
            HIGH_ML=0; MEDIUM_ML=0; LOW_ML=0
          fi

          # ---------------- AGGREGATE ----------------
          HIGH=$((HIGH_DOTNET + HIGH_ML))
          MEDIUM=$((MEDIUM_DOTNET + MEDIUM_ML))
          LOW=$((LOW_DOTNET + LOW_ML))
          TOTAL=$((HIGH + MEDIUM + LOW))

          # expose aggregated
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # expose dotnet
          echo "high_dotnet=$HIGH_DOTNET" >> $GITHUB_OUTPUT
          echo "medium_dotnet=$MEDIUM_DOTNET" >> $GITHUB_OUTPUT
          echo "low_dotnet=$LOW_DOTNET" >> $GITHUB_OUTPUT

          # expose ml
          echo "high_ml=$HIGH_ML" >> $GITHUB_OUTPUT
          echo "medium_ml=$MEDIUM_ML" >> $GITHUB_OUTPUT
          echo "low_ml=$LOW_ML" >> $GITHUB_OUTPUT

      - name: Save ZAP Metadata
        run: |
          mkdir -p scan-data
          cat > scan-data/zap-metadata.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "run_id": "${{ github.run_id }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "zap": {
              "dotnet": {
                "high": "${{ steps.zap.outputs.high_dotnet }}",
                "medium": "${{ steps.zap.outputs.medium_dotnet }}",
                "low": "${{ steps.zap.outputs.low_dotnet }}"
              },
              "ml": {
                "high": "${{ steps.zap.outputs.high_ml }}",
                "medium": "${{ steps.zap.outputs.medium_ml }}",
                "low": "${{ steps.zap.outputs.low_ml }}"
              },
              "total": {
                "high": "${{ steps.zap.outputs.high }}",
                "medium": "${{ steps.zap.outputs.medium }}",
                "low": "${{ steps.zap.outputs.low }}",
                "total": "${{ steps.zap.outputs.total }}"
              }
            }
          }
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: zap-metadata
          path: scan-data/

# =========================================================
# JOB 3: Dashboard
# =========================================================
  generate-dashboard:
    needs: [dast-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    permissions:
        contents: read
        pages: write
        id-token: write 

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: zap-metadata
          path: scan-data/

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Dashboard
        run: |
          mkdir -p dashboard
          node scripts/generate-dashboard.js

      - uses: actions/configure-pages@v4

      - uses: actions/upload-pages-artifact@v3
        with:
          path: ./dashboard

      - uses: actions/deploy-pages@v4