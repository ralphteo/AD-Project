name: CI-dotNet

on:
  push:
    branches:
      - main 
  pull_request:
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  PROJECT_PATH: './ADWebApplication/ADWebApplication.csproj'
  SKIP_KEYVAULT_IN_TESTS: "true"

# =========================================================
# JOB 1: SAST + SCA (SonarCloud + Snyk)
# =========================================================
jobs:
  build-and-sast-sca-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      security-events: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ---------------- SonarCloud ----------------
      - name: Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Sonar Begin
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner begin \
            /k:"GDipSA-Team-5_AD-Project" \
            /o:"gdipsa-team-5" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.opencover.reportsPaths="TestResults/**/coverage.opencover.xml" \
            /d:sonar.exclusions="**/.github/workflows/*.yml" \
            /d:sonar.coverage.exclusions="**/Models/**,**/ViewModels/**,**/*VM.cs,**/scripts/**,**/wwwroot/**,**/Dockerfile,**/Program.cs"
      
      - name: Restore & Build
        run: |
          dotnet restore ${{ env.PROJECT_PATH }}
          dotnet build ${{ env.PROJECT_PATH }} --no-restore

      - name: Test with Coverage
        run: |
          dotnet test ./ADWebApplication.Tests/ADWebApplication.Tests.csproj \
            --collect:"XPlat Code Coverage" \
            --settings coverlet.runsettings \
            --results-directory ./TestResults

      - name: Sonar End
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end

      # - name: Fetch SonarCloud Metrics
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   run: |
      #     curl -u "${SONAR_TOKEN}:" \
      #       "https://sonarcloud.io/api/measures/component?component=GDipSA-Team-5_AD-Project&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,security_hotspots" \
      #       -o sonar.json

      # - name: Parse Sonar Results
      #   id: sonar_results
      #   run: |
      #     BUGS=$(jq -r '.component.measures[]? | select(.metric=="bugs") | .value // "0"' sonar.json)
      #     VULN=$(jq -r '.component.measures[]? | select(.metric=="vulnerabilities") | .value // "0"' sonar.json)
      #     SMELLS=$(jq -r '.component.measures[]? | select(.metric=="code_smells") | .value // "0"' sonar.json)
      #     COVERAGE=$(jq -r '.component.measures[]? | select(.metric=="coverage") | .value // "0"' sonar.json)
      #     DUP=$(jq -r '.component.measures[]? | select(.metric=="duplicated_lines_density") | .value // "0"' sonar.json)
      #     HOTSPOTS=$(jq -r '.component.measures[]? | select(.metric=="security_hotspots") | .value // "0"' sonar.json)
      #     echo "bugs=$BUGS" >> $GITHUB_OUTPUT
      #     echo "vulnerabilities=$VULN" >> $GITHUB_OUTPUT
      #     echo "code_smells=$SMELLS" >> $GITHUB_OUTPUT
      #     echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
      #     echo "duplications=$DUP" >> $GITHUB_OUTPUT
      #     echo "hotspots=$HOTSPOTS" >> $GITHUB_OUTPUT

      # ---------------- Snyk .NET Dependency Scan ----------------
      - name: Install Snyk CLI
        run: npm install -g snyk --ignore-scripts

      - name: Authenticate Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth "$SNYK_TOKEN"

      - name: Run Snyk Test
        working-directory: ADWebApplication
        run: snyk test --severity-threshold=high --sarif-file-output=../snyk-dotnet.sarif
      
      - name: Upload Snyk SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: snyk-dotnet.sarif

      - name: Parse Snyk Results
        id: snyk_results
        run: |
          if [ -f snyk-dotnet.sarif ]; then
            HIGH=$(jq '[.runs[].results[]? | select(.level=="error")] | length' snyk-dotnet.sarif)
            MEDIUM=$(jq '[.runs[].results[]? | select(.level=="warning")] | length' snyk-dotnet.sarif)
            LOW=$(jq '[.runs[].results[]? | select(.level=="note")] | length' snyk-dotnet.sarif)
            TOTAL=$(jq '[.runs[].results[]?] | length' snyk-dotnet.sarif)
          else
            HIGH=0; MEDIUM=0; LOW=0; TOTAL=0
          fi
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: docker build -t in5nite-dotnet:snyk ./ADWebApplication

      - name: Snyk Container Scan
        run: |
          snyk container test in5nite-dotnet:snyk \
            --severity-threshold=high \
            --sarif-file-output=snyk-container.sarif

      - name: Upload Container SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: snyk-container.sarif

      # # Save metadata for dashboard
      # - name: Save SAST/SCA Metadata
      #   run: |
      #     mkdir -p scan-data
      #     cat > scan-data/sast-sca-metadata.json << EOF
      #     {
      #       "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
      #       "run_id": "${{ github.run_id }}",
      #       "run_number": "${{ github.run_number }}",
      #       "branch": "${{ github.ref_name }}",
      #       "commit": "${{ github.sha }}",
      #       "sonarcloud": {
      #         "bugs": "${{ steps.sonar_results.outputs.bugs }}",
      #         "vulnerabilities": "${{ steps.sonar_results.outputs.vulnerabilities }}",
      #         "code_smells": "${{ steps.sonar_results.outputs.code_smells }}",
      #         "security_hotspots": "${{ steps.sonar_results.outputs.hotspots }}",
      #         "coverage": "${{ steps.sonar_results.outputs.coverage }}",
      #         "duplications": "${{ steps.sonar_results.outputs.duplications }}"
      #       },
      #       "dependency_check": {
      #         "critical": "0",
      #         "high": "${{ steps.snyk_results.outputs.high }}",
      #         "medium": "${{ steps.snyk_results.outputs.medium }}",
      #         "low": "${{ steps.snyk_results.outputs.low }}",
      #         "total": "${{ steps.snyk_results.outputs.total }}"
      #       }
      #     }
      #     EOF

      # - uses: actions/upload-artifact@v4
      #   with:
      #     name: sast-sca-metadata
      #     path: scan-data/

# =========================================================
# JOB 2: DAST
# =========================================================
  dast-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Publish App
        run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --output publish

      - name: Run App Locally
        run: |
          ASPNETCORE_URLS=http://localhost:5000 nohup dotnet publish/ADWebApplication.dll &
          echo "Waiting for app to start..."
          until curl -s http://localhost:5000 > /dev/null; do
            sleep 2
          done
          echo "App is running!"

      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@4ea3deb659d9a669dc5e5c10c49a423e8bb41420
        with:
          target: 'http://localhost:5000'
          fail_action: false
          artifact_name: ''  # Disable artifact upload
          cmd_options: '-J zap-dotnet.json -r zap-dotnet.html'
          allow_issue_writing: false

      - name: ZAP Scan ML Service
        uses: zaproxy/action-baseline@4ea3deb659d9a669dc5e5c10c49a423e8bb41420
        with:
          target: 'https://in5nite-ml-fdcycfe6gkfnhdg2.southeastasia-01.azurewebsites.net'
          cmd_options: '-J zap-ml.json -r zap-ml.html'
          fail_action: false
          artifact_name: ''  # Disable artifact upload
          allow_issue_writing: false

      - name: Check and copy ZAP reports
        run: |
          echo "=== Checking current directory ==="
          ls -la *.json *.html 2>/dev/null || echo "No reports in root"
          
          echo "=== Checking /zap/wrk ==="
          sudo ls -la /zap/wrk/ 2>/dev/null || echo "/zap/wrk not accessible"
          
          # Copy .NET report
          if [ -f "zap-dotnet.json" ]; then
            echo "Found zap-dotnet.json in root"
            cp zap-dotnet.json zap.json
          elif [ -f "/zap/wrk/zap-dotnet.json" ]; then
            echo "Found zap-dotnet.json in /zap/wrk"
            sudo cp /zap/wrk/zap-dotnet.json zap.json
          else
            echo "WARNING: zap-dotnet.json not found, creating empty"
            echo '{"site":[{"alerts":[]}]}' > zap.json
          fi
          
          # Copy ML report
          if [ -f "zap-ml.json" ]; then
            echo "Found zap-ml.json in root"
            # Already in place
          elif [ -f "/zap/wrk/zap-ml.json" ]; then
            echo "Found zap-ml.json in /zap/wrk"
            sudo cp /zap/wrk/zap-ml.json zap-ml.json
          else
            echo "WARNING: zap-ml.json not found, creating empty"
            echo '{"site":[{"alerts":[]}]}' > zap-ml.json
          fi
          
          echo "=== Final report status ==="
          ls -la zap.json zap-ml.json
          echo "=== .NET Report Preview ==="
          jq '.site[].alerts[]? | {name: .name, risk: .riskcode}' zap.json | head -20
          echo "=== ML Report Preview ==="
          jq '.site[].alerts[]? | {name: .name, risk: .riskcode}' zap-ml.json | head -20

      - name: Parse ZAP (Aggregate .NET + ML)
        id: zap
        run: |
          # ---------------- DOTNET ----------------
          echo "Parsing .NET results..."
          if [ -f zap.json ]; then
            HIGH_DOTNET=$(jq '[.site[].alerts[]? | select(.riskcode=="3")] | length' zap.json)
            MEDIUM_DOTNET=$(jq '[.site[].alerts[]? | select(.riskcode=="2")] | length' zap.json)
            LOW_DOTNET=$(jq '[.site[].alerts[]? | select(.riskcode=="1")] | length' zap.json)
            INFO_DOTNET=$(jq '[.site[].alerts[]? | select(.riskcode=="0")] | length' zap.json)
            echo ".NET - High: $HIGH_DOTNET, Medium: $MEDIUM_DOTNET, Low: $LOW_DOTNET, Info: $INFO_DOTNET"
          else
            echo "ERROR: zap.json not found!"
            HIGH_DOTNET=0; MEDIUM_DOTNET=0; LOW_DOTNET=0; INFO_DOTNET=0
          fi
          
          # ---------------- ML ----------------
          echo "Parsing ML results..."
          if [ -f zap-ml.json ]; then
            HIGH_ML=$(jq '[.site[].alerts[]? | select(.riskcode=="3")] | length' zap-ml.json)
            MEDIUM_ML=$(jq '[.site[].alerts[]? | select(.riskcode=="2")] | length' zap-ml.json)
            LOW_ML=$(jq '[.site[].alerts[]? | select(.riskcode=="1")] | length' zap-ml.json)
            INFO_ML=$(jq '[.site[].alerts[]? | select(.riskcode=="0")] | length' zap-ml.json)
            echo "ML - High: $HIGH_ML, Medium: $MEDIUM_ML, Low: $LOW_ML, Info: $INFO_ML"
          else
            echo "ERROR: zap-ml.json not found!"
            HIGH_ML=0; MEDIUM_ML=0; LOW_ML=0; INFO_ML=0
          fi
          
          # ---------------- AGGREGATE ----------------
          HIGH=$((HIGH_DOTNET + HIGH_ML))
          MEDIUM=$((MEDIUM_DOTNET + MEDIUM_ML))
          LOW=$((LOW_DOTNET + LOW_ML))
          TOTAL=$((HIGH + MEDIUM + LOW))
          
          echo "=== AGGREGATED RESULTS ==="
          echo "High: $HIGH, Medium: $MEDIUM, Low: $LOW, Total: $TOTAL"
          
          # Output to GitHub
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "high_dotnet=$HIGH_DOTNET" >> $GITHUB_OUTPUT
          echo "medium_dotnet=$MEDIUM_DOTNET" >> $GITHUB_OUTPUT
          echo "low_dotnet=$LOW_DOTNET" >> $GITHUB_OUTPUT
          echo "high_ml=$HIGH_ML" >> $GITHUB_OUTPUT
          echo "medium_ml=$MEDIUM_ML" >> $GITHUB_OUTPUT
          echo "low_ml=$LOW_ML" >> $GITHUB_OUTPUT

      - name: Upload ZAP Reports for debugging
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-reports-raw
          path: |
            zap.json
            zap-ml.json
            zap-dotnet.html
            zap-ml.html

      - name: Save ZAP Metadata
        run: |
          mkdir -p scan-data
          cat > scan-data/zap-metadata.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "run_id": "${{ github.run_id }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "zap": {
              "dotnet": {
                "high": "${{ steps.zap.outputs.high_dotnet }}",
                "medium": "${{ steps.zap.outputs.medium_dotnet }}",
                "low": "${{ steps.zap.outputs.low_dotnet }}"
              },
              "ml": {
                "high": "${{ steps.zap.outputs.high_ml }}",
                "medium": "${{ steps.zap.outputs.medium_ml }}",
                "low": "${{ steps.zap.outputs.low_ml }}"
              },
              "total": {
                "high": "${{ steps.zap.outputs.high }}",
                "medium": "${{ steps.zap.outputs.medium }}",
                "low": "${{ steps.zap.outputs.low }}",
                "total": "${{ steps.zap.outputs.total }}"
              }
            }
          }
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: zap-metadata
          path: scan-data/

# =========================================================
# JOB 3: Dashboard
# =========================================================
  generate-dashboard:
    needs: [dast-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    permissions:
        contents: read
        pages: write
        id-token: write 

    steps:
      - uses: actions/checkout@v4

      # - uses: actions/download-artifact@v4
      #   with:
      #     name: sast-sca-metadata
      #     path: scan-data/

      - uses: actions/download-artifact@v4
        with:
          name: zap-metadata
          path: scan-data/

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Dashboard
        run: |
          mkdir -p dashboard
          node scripts/generate-dashboard.js

      - uses: actions/configure-pages@v4

      - uses: actions/upload-pages-artifact@v3
        with:
          path: ./dashboard

      - uses: actions/deploy-pages@v4