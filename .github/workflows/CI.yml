name: CI

on:
  pull_request:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DEPENDENCY_CHECK_VERSION: v9.0.7
  NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
  SKIP_KEYVAULT_IN_TESTS: "true"

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Make scripts executable
        run: chmod +x ./scripts/*.sh

      - name: Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Add .NET global tools to PATH
        run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
      
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Run SonarCloud Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORG: ${{ secrets.SONAR_ORG }}
        run: ./scripts/sast-sonar.sh

      - name: Upload Sonar Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sonar-report
          path: .sonarqube/out
                TestResults/**/coverage.opencover.xml
                TestResults/**/*.trx
                ADWebApplication.Tests/JavaScript/coverage/
          if-no-files-found: warn
          
      - name: SonarCloud Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1.2.0
        with:
          scanMetadataReportFile: .sonarqube/out/.sonar/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      #- name: Install OWASP Dependency-Check (This uses sca-dependency-check.sh instead of using the Owasp GitHub Action directly)
      #  run: |
      #    VERSION=${DEPENDENCY_CHECK_VERSION}
      #    wget https://github.com/jeremylong/DependencyCheck/releases/download/${VERSION}/dependency-check-${VERSION#v}-release.zip
      #    unzip dependency-check-*.zip
      #    chmod +x dependency-check/bin/dependency-check.sh
      #    sudo mv dependency-check /usr/local/dependency-check
      #    echo "/usr/local/dependency-check/bin" >> $GITHUB_PATH

      #- name: Cache Dependency-Check DB
      #  uses: actions/cache@v3
      #  with:
      #    path: ./dependency-check-data
      #    key: dependency-check-db-'$'{{ runner.os }}-v1
      #    restore-keys: |
      #      dependency-check-db-'$'{{ runner.os }}-v1

      #- name: Run Dependency-Check SCA
      #  run: ./scripts/sca-dependency-check.sh
      #  env:
      #    NVD_API_KEY: '$'{{ secrets.NVD_API_KEY }}

      
      # ---- OWASP Dependency-Check ----
      - name: Run OWASP Dependency-Check SCA
        uses: dependency-check/Dependency-Check_Action@1e54355a8b4c8abaa8cc7d0b70aa655a3bb15a6c
        with:
          project: ADWebApplication
          path: .
          format: ALL
          out: ./dependency-check-report
          args: >
            --failOnCVSS 12
            --suppression dependency-check-suppressions.xml
            --exclude '**/test/**'

      - name: Upload Dependency-Check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: ./dependency-check-report
