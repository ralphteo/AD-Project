@model ADWebApplication.Models.ReportIssueVM

@{
    ViewData["Title"] = "Issue Log";
    var totalIssues = Model.TotalIssues;
}

<div class="container py-4 issue-log">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 class="mb-1">Issue Log</h2>
            <p class="text-muted mb-0">Report and track bin-related issues</p>
        </div>
        <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#reportIssueModal">
            <i class="bi bi-plus-lg"></i> Report Issue
        </button>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Total Issues</div>
                <div class="stat-value">@Model.TotalIssues</div>
                <div class="stat-icon neutral"><i class="bi bi-exclamation-circle"></i></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Open</div>
                <div class="stat-value text-danger">@Model.OpenIssues</div>
                <div class="stat-icon danger"><i class="bi bi-x-circle"></i></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">In Progress</div>
                <div class="stat-value text-warning">@Model.InProgressIssues</div>
                <div class="stat-icon warning"><i class="bi bi-clock"></i></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Resolved</div>
                <div class="stat-value text-success">@Model.ResolvedIssues</div>
                <div class="stat-icon success"><i class="bi bi-check-circle"></i></div>
            </div>
        </div>
    </div>

    <div class="filter-card mb-4">
        <form method="get" asp-action="ReportIssue" class="filter-grid">
            <div class="filter-field">
                <label for="issueSearch" class="form-label">Search</label>
                <div class="input-with-icon">
                    <i class="bi bi-search"></i>
                    <input type="text" name="search" id="issueSearch" class="form-control" placeholder="Search issues..." value="@Model.Search">
                </div>
            </div>
            <div class="filter-field">
                <label for="issueStatus" class="form-label">Status</label>
                <select asp-for="StatusFilter" name="status" id="issueStatus" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="Open">Open</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Resolved">Resolved</option>
                </select>
            </div>
            <div class="filter-field">
                <label for="issuePriority" class="form-label">Priority</label>
                <select asp-for="PriorityFilter" name="priority" id="issuePriority" class="form-select">
                    <option value="">All Priorities</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">Search</button>
                <a asp-action="ReportIssue" class="btn btn-outline-secondary">Clear</a>
            </div>
        </form>
    </div>

    <div class="text-muted mb-3">Showing @Model.Issues.Count of @totalIssues issues</div>

    @if (Model.Issues.Any())
    {
        foreach (var issue in Model.Issues)
        {
            var severityClass = issue.Severity switch
            {
                "High" => "pill-danger",
                "Low" => "pill-low",
                _ => "pill-warning"
            };
            var statusClass = issue.Status switch
            {
                "Resolved" => "pill-success",
                "In Progress" => "pill-warning",
                _ => "pill-danger"
            };
            <div class="issue-card">
                <div class="issue-header">
                    <div class="issue-pills">
                        <span class="pill @severityClass">@issue.Severity.ToUpper()</span>
                        <span class="pill @statusClass">@issue.Status.ToUpper()</span>
                    </div>
                    <div class="issue-title">
                        <i class="bi bi-exclamation-circle"></i>
                        @( $"{issue.IssueType} - Bin B{issue.BinId:000}" )
                    </div>
                    <div class="issue-sub">@issue.Address</div>
                    <div class="issue-desc">@issue.Description</div>
                </div>
                <div class="issue-meta">
                    <div><i class="bi bi-pin-map"></i> Bin ID: @( $"B{issue.BinId:000}" )</div>
                    <div><i class="bi bi-person"></i> @issue.ReportedBy</div>
                    <div><i class="bi bi-clock"></i> @issue.ReportedAt.ToString("MMM dd, hh:mm tt")</div>
                </div>
                <div class="issue-actions">
                    <form asp-action="StartIssueWork" asp-controller="CollectorDashboard" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="stopId" value="@issue.StopId" />
                        <button class="btn btn-outline-secondary btn-sm" type="submit" @(issue.Status == "Resolved" ? "disabled" : "")>
                            @(issue.Status == "In Progress" ? "Mark Resolved" : issue.Status == "Resolved" ? "Resolved" : "Start Working")
                        </button>
                    </form>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info">No issues found.</div>
    }
</div>

<div class="modal fade" id="reportIssueModal" tabindex="-1" aria-labelledby="reportIssueModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportIssueModalLabel">Report an Issue</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form asp-action="ReportIssue" method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                    <div class="mb-3">
                        <label asp-for="BinId" class="form-label">Select Bin from Today's Route</label>
                        <select asp-for="BinId" class="form-select" id="binSelect" required>
                            <option value="">-- Select a bin --</option>
                            @foreach (var bin in Model.AvailableBins)
                            {
                                <option value="@bin.BinId" data-location="@bin.LocationName" data-region="@bin.Region">
                                    @bin.DisplayText
                                </option>
                            }
                        </select>
                        <span asp-validation-for="BinId" class="text-danger"></span>
                    </div>

                    <div id="locationDetails" class="alert alert-info" style="display: none;">
                        <h6>Location Details</h6>
                        <p class="mb-1"><strong>Location:</strong> <span id="displayLocation"></span></p>
                        <p class="mb-0"><strong>Region:</strong> <span id="displayRegion"></span></p>
                    </div>

                    <div class="mb-3">
                        <label asp-for="IssueType" class="form-label">Issue Type</label>
                        <select asp-for="IssueType" class="form-select" required>
                            <option value="">-- Select Issue Type --</option>
                            <option value="Overflow">Bin Overflow</option>
                            <option value="Damaged">Bin Damaged</option>
                            <option value="AccessIssue">Access Issue (Locked/Blocked)</option>
                            <option value="Missing">Bin Missing</option>
                            <option value="Other">Other</option>
                        </select>
                        <span asp-validation-for="IssueType" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Severity" class="form-label">Priority</label>
                        <select asp-for="Severity" class="form-select" required>
                            <option value="">-- Select Priority --</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                        <span asp-validation-for="Severity" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">Description</label>
                        <textarea asp-for="Description" class="form-control" rows="4" placeholder="Describe the issue in detail..." required></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            Submit Report
                        </button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/collector-dashboard.js" asp-append-version="true"></script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/collector-dashboard.css" asp-append-version="true" />
}
