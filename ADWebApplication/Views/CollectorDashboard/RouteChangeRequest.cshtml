@model ADWebApplication.Models.RouteChangeRequestVM

@{
    ViewData["Title"] = "Route Change Requests";
    var totalRequests = Model.TotalRequests;
}

<div class="container py-4 route-change">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 class="mb-1">Route Change Requests</h2>
            <p class="text-muted mb-0">Submit and track requests to modify your collection routes</p>
        </div>
        <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#routeChangeModal">
            <i class="bi bi-plus-lg"></i> New Request
        </button>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Total Requests</div>
                <div class="stat-value">@Model.TotalRequests</div>
                <div class="stat-icon neutral"><i class="bi bi-arrow-repeat"></i></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Pending</div>
                <div class="stat-value text-warning">@Model.PendingRequests</div>
                <div class="stat-icon warning"><i class="bi bi-clock"></i></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Approved</div>
                <div class="stat-value text-success">@Model.ApprovedRequests</div>
                <div class="stat-icon success"><i class="bi bi-check-circle"></i></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-label">Rejected</div>
                <div class="stat-value text-danger">@Model.RejectedRequests</div>
                <div class="stat-icon danger"><i class="bi bi-x-circle"></i></div>
            </div>
        </div>
    </div>

    <div class="filter-card mb-4">
        <form method="get" asp-action="RouteChangeRequest" class="filter-grid">
            <div class="filter-field">
                <label class="form-label">Search</label>
                <div class="input-with-icon">
                    <i class="bi bi-search"></i>
                    <input type="text" name="search" class="form-control" placeholder="Search requests..." value="@Model.Search">
                </div>
            </div>
            <div class="filter-field">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="Pending" selected="@(Model.StatusFilter == "Pending")">Pending</option>
                    <option value="Approved" selected="@(Model.StatusFilter == "Approved")">Approved</option>
                    <option value="Rejected" selected="@(Model.StatusFilter == "Rejected")">Rejected</option>
                </select>
            </div>
            <div class="filter-field">
                <label class="form-label">Priority</label>
                <select name="priority" class="form-select">
                    <option value="">All Priorities</option>
                    <option value="High" selected="@(Model.PriorityFilter == "High")">High</option>
                    <option value="Medium" selected="@(Model.PriorityFilter == "Medium")">Medium</option>
                    <option value="Low" selected="@(Model.PriorityFilter == "Low")">Low</option>
                </select>
            </div>
            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">Search</button>
                <a asp-action="RouteChangeRequest" class="btn btn-outline-secondary">Clear</a>
            </div>
        </form>
    </div>

    <div class="text-muted mb-3">Showing @Model.Requests.Count of @totalRequests requests</div>

    @if (Model.Requests.Any())
    {
        foreach (var request in Model.Requests)
        {
            var priorityClass = request.Priority switch
            {
                "High" => "pill-danger",
                "Low" => "pill-low",
                _ => "pill-warning"
            };
            var statusClass = request.Status switch
            {
                "Approved" => "pill-success",
                "Rejected" => "pill-danger",
                _ => "pill-warning"
            };
            <div class="request-card">
                <div class="request-header">
                    <div class="request-pills">
                        <span class="pill @priorityClass">@request.Priority.ToUpper()</span>
                        <span class="pill @statusClass">@request.Status.ToUpper()</span>
                    </div>
                    <div class="request-title">@request.RequestType</div>
                    <div class="request-sub">Request ID: @request.RequestId</div>
                </div>
                <div class="request-body">
                    <div class="request-row">
                        <i class="bi bi-pin-map"></i>
                        <div>
                            <div class="request-label">@request.RouteName</div>
                            <div class="request-meta">Reason: @request.Reason</div>
                        </div>
                    </div>
                    <div class="request-desc">@request.Description</div>
                </div>
                <div class="request-meta-row">
                    <div><i class="bi bi-person"></i> Requested by: @request.RequestedBy</div>
                    <div><i class="bi bi-clock"></i> @request.RequestedAt.ToString("MMM dd, yyyy, hh:mm tt")</div>
                </div>

                @if (!string.IsNullOrWhiteSpace(request.ReviewedBy) || !string.IsNullOrWhiteSpace(request.ReviewNote))
                {
                    <div class="review-box">
                        <div class="review-title">Reviewed by @request.ReviewedBy</div>
                        @if (!string.IsNullOrWhiteSpace(request.ReviewNote))
                        {
                            <div class="review-note">@request.ReviewNote</div>
                        }
                        @if (request.ReviewedAt.HasValue)
                        {
                            <div class="review-time">@request.ReviewedAt.Value.ToString("MMM dd, yyyy, hh:mm tt")</div>
                        }
                    </div>
                }
            </div>
        }
    }
    else
    {
        <div class="alert alert-info">No route change requests found.</div>
    }
</div>

<div class="modal fade" id="routeChangeModal" tabindex="-1" aria-labelledby="routeChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="routeChangeModalLabel">Request Route Change</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form asp-action="RouteChangeRequest" method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                    <div class="mb-3">
                        <label asp-for="RouteId" class="form-label">Current Route</label>
                        <select asp-for="RouteId" class="form-select" required>
                            <option value="">Select route...</option>
                            @foreach (var route in Model.AvailableRoutes)
                            {
                                <option value="@route.RouteId">@route.DisplayText</option>
                            }
                        </select>
                        <span asp-validation-for="RouteId" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="RequestType" class="form-label">Request Type</label>
                        <select asp-for="RequestType" class="form-select" required>
                            <option value="">Select request type...</option>
                            <option value="Route Modification">Route Modification</option>
                            <option value="Remove Bin">Remove Bin</option>
                            <option value="Route Swap">Route Swap</option>
                            <option value="Other">Other</option>
                        </select>
                        <span asp-validation-for="RequestType" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Reason" class="form-label">Reason</label>
                        <input asp-for="Reason" class="form-control" placeholder="e.g., Road construction, equipment issue, personal request..." required />
                        <span asp-validation-for="Reason" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Priority" class="form-label">Priority</label>
                        <select asp-for="Priority" class="form-select" required>
                            <option value="">Select priority...</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                        <span asp-validation-for="Priority" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">Description</label>
                        <textarea asp-for="Description" class="form-control" rows="4" placeholder="Provide detailed information about your request..." required></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Submit Request</button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}

<style>
    .route-change .stat-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
        border: 1px solid #eef2f7;
        position: relative;
        min-height: 110px;
    }

    .route-change .stat-label {
        color: #64748b;
        font-weight: 600;
    }

    .route-change .stat-value {
        font-size: 28px;
        font-weight: 700;
        margin-top: 6px;
    }

    .route-change .stat-icon {
        position: absolute;
        right: 16px;
        top: 16px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .route-change .stat-icon.neutral { background: #e2e8f0; color: #64748b; }
    .route-change .stat-icon.danger { background: #fee2e2; color: #ef4444; }
    .route-change .stat-icon.warning { background: #ffedd5; color: #f97316; }
    .route-change .stat-icon.success { background: #dcfce7; color: #16a34a; }

    .route-change .filter-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
        border: 1px solid #eef2f7;
    }

    .route-change .filter-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr auto;
        gap: 16px;
        align-items: end;
    }

    .route-change .input-with-icon { position: relative; }
    .route-change .input-with-icon i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
    }
    .route-change .input-with-icon input { padding-left: 38px; }

    .route-change .filter-actions { display: flex; gap: 10px; }

    .route-change .request-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 18px;
        border: 1px solid #eef2f7;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
        margin-bottom: 18px;
    }

    .route-change .request-pills { display: flex; gap: 8px; margin-bottom: 12px; }
    .route-change .pill { font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 999px; }
    .route-change .pill-danger { background: #fee2e2; color: #b91c1c; }
    .route-change .pill-warning { background: #ffedd5; color: #c2410c; }
    .route-change .pill-success { background: #dcfce7; color: #15803d; }
    .route-change .pill-low { background: #e0f2fe; color: #0369a1; }

    .route-change .request-title { font-weight: 700; margin-bottom: 4px; }
    .route-change .request-sub { color: #64748b; margin-bottom: 8px; }
    .route-change .request-row { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px; }
    .route-change .request-row i { color: #94a3b8; margin-top: 3px; }
    .route-change .request-label { font-weight: 600; }
    .route-change .request-meta { color: #64748b; }
    .route-change .request-desc { color: #0f172a; margin-bottom: 12px; }

    .route-change .request-meta-row {
        display: flex;
        gap: 24px;
        padding-top: 12px;
        border-top: 1px solid #eef2f7;
        color: #64748b;
        flex-wrap: wrap;
    }

    .route-change .review-box {
        margin-top: 14px;
        padding: 12px 14px;
        border-radius: 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
    }

    .route-change .review-title { font-weight: 600; margin-bottom: 6px; }
    .route-change .review-note { color: #0f172a; }
    .route-change .review-time { color: #64748b; margin-top: 6px; }

    @@media (max-width: 768px) {
        .route-change .filter-grid { grid-template-columns: 1fr; }
        .route-change .filter-actions { justify-content: flex-start; }
    }
</style>
