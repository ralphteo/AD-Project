@model ADWebApplication.Models.ViewModels.RoutePlanningViewModel

@{
    ViewData["Title"] = "Route Management";
    Layout = "_DashboardLayout";

    var activeOfficerIds = Model.AllStops
    .Select(s => s.RouteKey)
    .Distinct()
    .OrderBy(k => k)
    .ToList();

    var totalHighPriority = Model.AllStops
        .Where(s => s.IsHighPriority)
        .Select(s => s.BinId)
        .Distinct()
        .Count();

    var plannedHighPriority = Model.AllStops
        .Where(s => s.IsHighPriority && !string.IsNullOrEmpty(s.AssignedOfficerName))
        .Select(s => s.BinId)
        .Distinct()
        .Count();
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #routeMap {
        height: 700px;
        width: 100%;
        border-radius: 12px;
        background: #ebf0f1;
    }

    .officer-card {
        cursor: pointer;
        border-left: 4px solid transparent;
        transition: 0.2s;
        margin-bottom: 10px;
    }

    .officer-card:hover {
        border-left-color: #007bff;
        background: #fdfdfd;
        transform: translateX(5px);
    }

    .sidebar-container {
        height: 700px;
        overflow-y: auto;
        scrollbar-width: thin;
    }

    /* Subtle glow for the selected route */
    .leaflet-interactive {
        transition: stroke-width 0.2s, stroke-opacity 0.2s;
    }

    .officer-header {
        cursor: pointer;
    }

    .toggle-icon {
        transition: transform 0.2s ease;
    }

    .officer-header[aria-expanded="false"] .toggle-icon {
        transform: rotate(-90deg);
    }
</style>

<div class="row g-3 mb-3 align-items-stretch">

    <div class="col-md-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-muted mb-1">Collection Date</h6>
                <h4 class="fw-bold mb-0">
                    @Model.CollectionDate
                </h4>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h3 class="fw-bold text-danger">@totalHighPriority</h3>
                <div class="text-muted">High Priority Bins</div>
                <small>≤ 1 day to 80%</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h3 class="fw-bold text-success">
                    @plannedHighPriority / @totalHighPriority
                </h3>
                <div class="text-muted">Planned Today</div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h3 class="fw-bold">@activeOfficerIds.Count</h3>
                <div class="text-muted">Officers Deployed</div>
            </div>
        </div>
    </div>

</div>

@if (plannedHighPriority < totalHighPriority)
{
    <div class="alert alert-danger d-flex justify-content-between align-items-center">
        <div>
            <strong>@(totalHighPriority - plannedHighPriority) high-priority bins are not scheduled</strong><br />
            Immediate action required to prevent overflow
        </div>
    </div>
}
else
{
    <div class="alert alert-success">
        <strong>All high-priority bins are scheduled for collection today</strong>
    </div>
}

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0">
            <div id="routeMap"></div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="sidebar-container pe-2">
            <h5 class="fw-bold mb-3">Officer Schedules</h5>

            @foreach (var route in Model.Routes)
            {
                var coStops = route.Stops;

                <div class="card officer-card shadow-sm mb-3" data-officer-id="@route.RouteKey">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center officer-header"
                        role="button"
                        aria-expanded="true"
                        data-target="stops-@route.RouteKey">

                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-chevron-down toggle-icon"></i>
                            <h6 class="fw-bold mb-0 text-primary">
                                Route #@route.RouteKey
                            </h6>
                        </div>

                        <span class="badge bg-light text-dark border">
                            @coStops.Count stops · <span class="route-distance"></span> km
                        </span>
                    </div>

                    @if (!string.IsNullOrEmpty(route.AssignedOfficerName))
                    {
                        <div class="text-muted small mt-1">
                            Assigned to: <strong>@route.AssignedOfficerName</strong>
                        </div>
                    }


                    <form method="post" asp-action="AssignRoute" class="p-3 border-top">
                        @Html.AntiForgeryToken()

                        <input type="hidden" name="RouteId" value="@route.RouteKey" />

                        <select name="OfficerUsername" class="form-select mb-2" required>
                            <option value="">Select Officer</option>
                            @foreach (var officer in Model.AvailableOfficers)
                            {
                                <option value="@officer.Username">
                                    @officer.FullName
                                </option>
                            }
                        </select>

                        @if (!string.IsNullOrEmpty(route.AssignedOfficerName))
                        {
                            <button class="btn btn-sm btn-secondary w-100" disabled>
                                Assigned
                            </button>
                        }
                        else
                        {
                            <button type="submit" class="btn btn-sm btn-primary w-100">
                                Assign & Save Route
                            </button>
                        }
                    </form>

                    <!-- Stops -->
                    <div class="collapse show" id="stops-@route.RouteKey">
                        <ul class="list-group list-group-flush">
                            @foreach (var stop in coStops)
                            {
                                <li class="list-group-item border-0 py-2 px-3 border-bottom">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge bg-primary me-2">@stop.StopNumber</span>
                                            <span class="fw-bold">Bin @stop.BinId</span>
                                        </div>

                                        @if (stop.IsHighPriority)
                                        {
                                            <span class="badge bg-danger" style="font-size: 0.65rem;">
                                                HIGH PRIORITY
                                            </span>
                                        }
                                    </div>
                                </li>
                            }
                    </ul>
               </div>
            </div>
        }
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        //calculate distance
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;

            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) *
                Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        document.addEventListener("DOMContentLoaded", function () {
            // 1. Initialize Map with a CLEAN style (CartoDB Positron)
            var map = L.map('routeMap', { zoomControl: false }).setView([1.3521, 103.8198], 12);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '©OpenStreetMap'
            }).addTo(map);

            var rawStops = @Html.Raw(Json.Serialize(Model.AllStops));
            const getV = (o, k) => o[k.charAt(0).toLowerCase() + k.slice(1)] ?? o[k];

            var routeLayers = {};
            var colors = ['#FF3B30', '#34C759', '#007AFF', '#FF9500', '#AF52DE', '#5856D6', '#5AC8FA'];
            var bounds = L.latLngBounds();

            // 2. Group data
            var grouped = {};
            rawStops.forEach(s => {
                var id = getV(s, 'RouteKey');
                (grouped[id] = grouped[id] || []).push(s);
            });

            // 3. Draw Routes
            Object.keys(grouped).forEach(id => {
                var stops = grouped[id].sort((a, b) => getV(a, 'StopNumber') - getV(b, 'StopNumber'));
                var color = colors[(id - 1) % colors.length];
                var latLngs = stops.map(s => {
                    var p = [getV(s, 'Latitude'), getV(s, 'Longitude')];
                    bounds.extend(p);
                    return p;
                });

                let totalDistance = 0;

                for (let i = 1; i < stops.length; i++) {
                    totalDistance += haversine(
                        getV(stops[i - 1], 'Latitude'),
                        getV(stops[i - 1], 'Longitude'),
                        getV(stops[i], 'Latitude'),
                        getV(stops[i], 'Longitude')
                    );
                }

                totalDistance = totalDistance.toFixed(1); // km

                const card = document.querySelector(`.officer-card[data-officer-id="${id}"]`);
                if (card) {
                    const span = card.querySelector('.route-distance');
                    if (span) span.innerText = totalDistance;
                }

                // The main route line - faint by default
                var poly = L.polyline(latLngs, {
                    color: color,
                    weight: 4,
                    opacity: 0.25,
                    lineCap: 'round'
                }).addTo(map);

                routeLayers[id] = poly;

                // Only add markers for High Priority or the Start/End to keep it clean
                stops.forEach((s, index) => {
                    if (getV(s, 'IsHighPriority') || index === 0) {
                        L.circleMarker([getV(s, 'Latitude'), getV(s, 'Longitude')], {
                            radius: getV(s, 'IsHighPriority') ? 6 : 4,
                            color: color,
                            fillOpacity: 1,
                            weight: 2,
                            fillColor: getV(s, 'IsHighPriority') ? 'red' : 'white'
                        }).addTo(map).bindPopup(`Officer ${id} - Stop ${getV(s, 'StopNumber')}`);
                    }
                });
            });

            if (bounds.isValid()) map.fitBounds(bounds, { padding: [50, 50] });

            // 4. Interactive Hover Effect
            document.querySelectorAll('.officer-card').forEach(card => {
                var id = card.getAttribute('data-officer-id');

                card.addEventListener('mouseenter', () => {
                    if (routeLayers[id]) {
                        routeLayers[id].setStyle({ opacity: 1, weight: 6 });
                        routeLayers[id].bringToFront();
                    }
                });

                card.addEventListener('mouseleave', () => {
                    if (routeLayers[id]) {
                        routeLayers[id].setStyle({ opacity: 0.25, weight: 4 });
                    }
                });

                card.addEventListener('click', () => {
                    map.fitBounds(routeLayers[id].getBounds(), { padding: [100, 100] });
                });
            });

            setTimeout(() => map.invalidateSize(), 300);
        });

        // 5. Collapsible Routes
        document.querySelectorAll('.officer-header').forEach(header => {
            header.addEventListener('click', () => {
                const targetId = header.getAttribute('data-target');
                const body = document.getElementById(targetId);

                if (!body) return;

                const isShown = body.classList.contains('show');

                body.classList.toggle('show', !isShown);
                header.setAttribute('aria-expanded', (!isShown).toString());
            });
        });

        // 6. Auto Collapse all but the first route
        document.addEventListener("DOMContentLoaded", function () {
            const headers = document.querySelectorAll('.officer-header');

            headers.forEach((header, index) => {
                const targetId = header.getAttribute('data-target');
                const body = document.getElementById(targetId);

                if (!body) return;

                // Collapse all except the first route
                if (index !== 0) {
                    body.classList.remove('show');
                    header.setAttribute('aria-expanded', 'false');
                } else {
                    header.setAttribute('aria-expanded', 'true');
                }
            });
        });
    </script>