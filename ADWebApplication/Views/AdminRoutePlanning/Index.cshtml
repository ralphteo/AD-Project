@model ADWebApplication.Models.ViewModels.RoutePlanningViewModel

@{
    ViewData["Title"] = "Route Management";
    Layout = "_DashboardLayout";
    var activeOfficerIds = Model.AllStops.Where(s => s.AssignedCO > 0).Select(s => s.AssignedCO).Distinct().OrderBy(id => id).ToList();
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #routeMap { height: 700px; width: 100%; border-radius: 12px; background: #ebf0f1; }
    .officer-card { cursor: pointer; border-left: 4px solid transparent; transition: 0.2s; margin-bottom: 10px; }
    .officer-card:hover { border-left-color: #007bff; background: #fdfdfd; transform: translateX(5px); }
    .sidebar-container { height: 700px; overflow-y: auto; scrollbar-width: thin; }
    /* Subtle glow for the selected route */
    .leaflet-interactive { transition: stroke-width 0.2s, stroke-opacity 0.2s; }
</style>

<div class="container-fluid pt-3">
    <div class="row mb-3">
        <div class="col-md-8">
            <h2 class="fw-bold text-dark">Route Planning</h2>
            <p class="text-muted">Collection Schedule: @Model.CollectionDate</p>
        </div>
        <div class="col-md-4 text-end">
             <span class="badge bg-dark p-2">Total Bins: @Model.TotalBins</span>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div id="routeMap"></div>
            </div>
        </div>

        <div class="col-lg-4">
    <div class="sidebar-container pe-2">
        <h5 class="fw-bold mb-3">Officer Schedules</h5>
        
        @foreach (var coId in activeOfficerIds)
        {
            // 1. Get ALL stops for this officer, ordered correctly
            var coStops = Model.AllStops
                .Where(s => s.AssignedCO == coId)
                .OrderBy(s => s.StopNumber)
                .ToList();

            <div class="card officer-card shadow-sm mb-3" data-officer-id="@coId">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-primary">Officer #@coId</h6>
                    <span class="badge bg-light text-dark border">@coStops.Count Stops</span>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        @foreach (var stop in coStops)
                        {
                            <li class="list-group-item border-0 py-2 px-3 border-bottom">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-primary me-2">@stop.StopNumber</span>
                                        <span class="fw-bold">Bin @stop.BinId</span>
                                    </div>
                                    @if (stop.IsHighPriority)
                                    {
                                        <span class="badge bg-danger" style="font-size: 0.65rem;">HIGH PRIORITY</span>
                                    }
                                </div>
                                <div class="text-muted small mt-1">
                                    <i class="bi bi-geo-alt"></i> Lat: @stop.Latitude, Lng: @stop.Longitude
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        }
    </div>
    </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 1. Initialize Map with a CLEAN style (CartoDB Positron)
        var map = L.map('routeMap', { zoomControl: false }).setView([1.3521, 103.8198], 12);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â©OpenStreetMap'
        }).addTo(map);

        var rawStops = @Html.Raw(Json.Serialize(Model.AllStops));
        const getV = (o, k) => o[k.charAt(0).toLowerCase() + k.slice(1)] ?? o[k];

        var routeLayers = {}; 
        var colors = ['#FF3B30', '#34C759', '#007AFF', '#FF9500', '#AF52DE', '#5856D6', '#5AC8FA'];
        var bounds = L.latLngBounds();

        // 2. Group data
        var grouped = {};
        rawStops.forEach(s => {
            var id = getV(s, 'AssignedCO');
            if(id > 0) (grouped[id] = grouped[id] || []).push(s);
        });

        // 3. Draw Routes
        Object.keys(grouped).forEach(id => {
            var stops = grouped[id].sort((a,b) => getV(a,'StopNumber') - getV(b,'StopNumber'));
            var color = colors[(id-1) % colors.length];
            var latLngs = stops.map(s => {
                var p = [getV(s, 'Latitude'), getV(s, 'Longitude')];
                bounds.extend(p);
                return p;
            });

            // The main route line - faint by default
            var poly = L.polyline(latLngs, {
                color: color,
                weight: 4,
                opacity: 0.25,
                lineCap: 'round'
            }).addTo(map);

            routeLayers[id] = poly;

            // Only add markers for High Priority or the Start/End to keep it clean
            stops.forEach((s, index) => {
                if(getV(s, 'IsHighPriority') || index === 0) {
                    L.circleMarker([getV(s, 'Latitude'), getV(s, 'Longitude')], {
                        radius: getV(s, 'IsHighPriority') ? 6 : 4,
                        color: color,
                        fillOpacity: 1,
                        weight: 2,
                        fillColor: getV(s, 'IsHighPriority') ? 'red' : 'white'
                    }).addTo(map).bindPopup(`Officer ${id} - Stop ${getV(s, 'StopNumber')}`);
                }
            });
        });

        if (bounds.isValid()) map.fitBounds(bounds, { padding: [50, 50] });

        // 4. Interactive Hover Effect
        document.querySelectorAll('.officer-card').forEach(card => {
            var id = card.getAttribute('data-officer-id');
            
            card.addEventListener('mouseenter', () => {
                if(routeLayers[id]) {
                    routeLayers[id].setStyle({ opacity: 1, weight: 6 });
                    routeLayers[id].bringToFront();
                }
            });

            card.addEventListener('mouseleave', () => {
                if(routeLayers[id]) {
                    routeLayers[id].setStyle({ opacity: 0.25, weight: 4 });
                }
            });

            card.addEventListener('click', () => {
                map.fitBounds(routeLayers[id].getBounds(), { padding: [100, 100] });
            });
        });

        setTimeout(() => map.invalidateSize(), 300);
    });
</script>