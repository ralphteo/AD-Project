@{
    ViewData["Title"] = "Collection Calendar";
    Layout = "_DashboardLayout";
}

<div class="container-fluid">
    <h2 class="mb-4 d-flex align-items-center justify-content-between">
        <span>
            <i class="bi bi-calendar3"></i> Collection Calendar
        </span>
    </h2>

    <!-- Back Button -->
    <div class="mb-3">
        <a class="btn btn-outline-secondary" href="@Url.Action("CollectionOfficerRoster", "Admin")">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>

    <div class="row">
        <!-- Calendar Section -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" id="calendarMonth">Calendar</h5>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="prevMonth()">◀</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="nextMonth()">▶</button>
                    </div>
                </div>

                <div class="card-body">
                    <div class="calendar-grid" id="calendar"></div>

                    <!-- Selected Range -->
                    <div class="d-flex flex-wrap align-items-center gap-2 mt-3">
                        <!-- Available From -->
                        <div class="d-flex align-items-center gap-2 flex-grow-1 min-w-150">
                            <label class="mb-0" for="dateFrom">Available From:</label>
                            <input type="date" id="dateFrom" name="dateFrom" class="form-control" value="@Context.Request.Query["dateFrom"]" required />
                        </div>

                        <!-- Available To -->
                        <div class="d-flex align-items-center gap-2 flex-grow-1 min-w-150">
                            <label class="mb-0" for="dateTo">Available To:</label>
                            <input type="date" id="dateTo" name="dateTo" class="form-control" value="@Context.Request.Query["dateTo"]" required />
                        </div>

                        <!-- Check Availability Button -->
                        <div class="flex-shrink-0">
                            <button type="button" class="btn btn-primary" onclick="loadAvailableOfficers()">
                                <i class="bi bi-check-circle"></i> Check Availability
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        

        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-people"></i> Collection Officers
                    </h5>
                </div>

                <div class="card-body">

                    <h6 class="fw-bold text-success">
                        <i class="bi bi-person-check"></i> Available
                    </h6>
                    <ul class="list-group mb-3" id="availableList"></ul>

                    <h6 class="fw-bold text-danger">
                        <i class="bi bi-person-x"></i> Assigned
                    </h6>
                    <ul class="list-group" id="assignedList"></ul>

                </div>
            </div>
        </div>
    </div>
</div>


<!-- Available Officer Modal -->
<div class="modal fade" id="availableModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Available Officer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="availableOfficerName"></p>
        <p class="mb-2 fw-semibold">Date Range:</p>
        <ul class="list-group">
            <li class="list-group-item d-flex align-items-center" id="availableDateRange">
                <!-- filled by JS -->
            </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Assigned Officer Modal -->
<div class="modal fade" id="assignedModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Assigned Officer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="assignedOfficerName"></p>
        <p class="mb-2 fw-semibold">Planned Dates:</p>
        <ul class="list-group" id="assignedPlannedDates"></ul>
      </div>
    </div>
  </div>
</div>

<style>
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }

    .calendar-day {
        text-align: center;
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        border: 1px solid #dee2e6;
    }

    .calendar-day:hover {
        background-color: #f1f3f5;
    }

    .calendar-day.selected {
        background-color: #0d6efd;
        color: white;
    }

    .calendar-day.today {
        border: 2px solid #0d6efd;
    }

    .calendar-header {
        font-weight: bold;
        text-align: center;
    }
    
    .calendar-day.weekend {
        background-color: #f1f1f1;
        color: #aaa;
        cursor: not-allowed;
    }

</style>

@section Scripts {
<script>
    let currentDate = new Date();
    let dateFrom = null;
    let dateTo = null;
    let hoverDate = null;

    const availableList = document.getElementById("availableList");
    const assignedList = document.getElementById("assignedList");

    function renderCalendar() {
        const calendar = document.getElementById("calendar");
        calendar.innerHTML = "";

        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();

        document.getElementById("calendarMonth").innerText =
            currentDate.toLocaleString("default", { month: "long", year: "numeric" });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Render day headers
        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        days.forEach(d => {
            const header = document.createElement("div");
            header.className = "calendar-header";
            header.innerText = d;
            calendar.appendChild(header);
        });

        // Empty cells for first day offset
        for (let i = 0; i < firstDay; i++) {
            calendar.appendChild(document.createElement("div"));
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const cell = document.createElement("div");
            cell.className = "calendar-day";
            cell.innerText = day;

            // Skip weekends for selection
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            if (isWeekend) {
                cell.classList.add("weekend");
                calendar.appendChild(cell);
                continue;
            }

            // Today
            if (isSameDay(date, new Date())) cell.classList.add("today");

            // --- Click-selected highlight (confirmed range) ---
            if (dateFrom && dateTo && date >= stripTime(dateFrom) && date <= stripTime(dateTo)) {
                cell.classList.add("selected");
            }
            // --- Hover preview (only if dateTo not set) ---
            else if (dateFrom && !dateTo && hoverDate) {
                const start = stripTime(dateFrom);
                const end = stripTime(hoverDate);
                const minDate = start < end ? start : end;
                const maxDate = start > end ? start : end;

                if (date >= minDate && date <= maxDate) {
                    cell.classList.add("selected");
                }
            }
            // --- Single start-date highlight (no hover) ---
            else if (dateFrom && !dateTo && !hoverDate && isSameDay(date, dateFrom)) {
                cell.classList.add("selected");
            }

            // Click handler
            cell.onclick = () => onCalendarClick(date);

            // Hover handlers
            cell.onmouseenter = () => {
            if (dateFrom && !dateTo && !isWeekend) {
                hoverDate = date;
                updateHoverClasses(); // ✅ no full re-render
                }
            };

            cell.onmouseleave = () => {
                if (hoverDate === date) {
                    hoverDate = null;
                    updateHoverClasses(); // ✅ remove hover highlight
                }
            };

            calendar.appendChild(cell);
        }
    }


    function onCalendarClick(date) {
        // Case 1: nothing selected
        if (!dateFrom && !dateTo) {
            dateFrom = date;
            dateTo = null;
        }
        // Case 2: only start selected
        else if (dateFrom && !dateTo) {
            if (isSameDay(date, dateFrom)) {
                // clicked same day → set dateTo = dateFrom (single-day range)
                dateTo = dateFrom;
            } else if (date < dateFrom) {
                dateTo = dateFrom;
                dateFrom = date;
            } else {
                dateTo = date;
            }
        }
        // Case 3: range selected
        else if (dateFrom && dateTo) {
            // clicking start or end → reset to new start
            dateFrom = date;
            dateTo = null;
        }

        hoverDate = null; // reset hover preview after click
        syncInputs();
        renderCalendar();
    }

    // Sync input fields with calendar
    function syncInputs() {
        document.getElementById("dateFrom").value = dateFrom ? formatDate(dateFrom) : "";
        document.getElementById("dateTo").value = dateTo ? formatDate(dateTo) : dateFrom ? formatDate(dateFrom) : "";
    }

    // Utility functions
    function stripTime(date) {
        return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
    }

    function isSameDay(a, b) {
        return a.toDateString() === b.toDateString();
    }

    // Navigation
    function prevMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    }

    // AJAX: only triggered by "Check Availability" button
    function loadAvailableOfficers() {
        if (!dateFrom) return alert("Please select a start date.");
        if (!dateTo) dateTo = dateFrom;

        fetch(`/Admin/GetOfficerAvailability?from=${formatDate(dateFrom)}&to=${formatDate(dateTo)}`)
            .then(res => res.json())
            .then(data => renderAvailability(data))
            .catch(err => console.error("Availability error:", err));
    }

    // Render officer availability
    function renderAvailability(data) {
        const available = data.available;
        const assigned  = data.assigned;

        availableList.innerHTML = "";
        assignedList.innerHTML = "";

        // Available Officers
        data.available.forEach(o => {
            availableList.innerHTML += `
            <li class="list-group-item list-group-item-success d-flex justify-content-between align-items-center" 
                style="cursor:pointer" 
                onclick="openAvailableModal('${o.username}','${o.fullName}')">
                <span><i class="bi bi-person"></i> ${o.username} | ${o.fullName}</span>
                <span class="badge bg-success">Free</span>
            </li>`;
        });

        if (data.available.length === 0) {
            availableList.innerHTML =
                `<li class="list-group-item text-muted">No officers available.</li>`;
        }

        // Assigned Officers
        data.assigned.forEach(o => {
            const plannedDates = o.plannedDates ?? [];

            assignedList.innerHTML += `
                <li class="list-group-item list-group-item-danger d-flex justify-content-between align-items-center" 
                    style="cursor:pointer" 
                    onclick='openAssignedModal(
                        "${o.username}",
                        "${o.fullName}",
                        ${JSON.stringify(plannedDates)}
                    )'>
                    <span>
                        <i class="bi bi-person"></i> ${o.username} | ${o.fullName}
                    </span>
                    <span class="badge bg-danger">
                        ${plannedDates.length} route(s)
                    </span>
                </li>`;
        });

        if (data.assigned.length === 0) {
            assignedList.innerHTML =
                `<li class="list-group-item text-muted">No officers are currently assigned.</li>`;
        }
    }

    // For Available Officers
    function openAvailableModal(username, fullName) {
        document.getElementById("availableOfficerName").innerText =
            `${fullName} (${username})`;

        const rangeText =
            formatDate(dateFrom) + " → " + formatDate(dateTo || dateFrom);

        document.getElementById("availableDateRange").innerHTML = `
            <i class="bi bi-calendar-event me-2 text-success"></i>
            ${rangeText}
        `;

        new bootstrap.Modal(document.getElementById("availableModal")).show();
    }

    // For Assigned Officers
    function openAssignedModal(username, fullName, plannedDates) {
        document.getElementById("assignedOfficerName").innerText =
            `${fullName} (${username})`;

        const list = document.getElementById("assignedPlannedDates");
        list.innerHTML = "";

        if (!plannedDates || plannedDates.length === 0) {
            list.innerHTML =
                `<li class="list-group-item text-muted">No planned routes</li>`;
            return;
        }

        // Sort plannedDates by date ascending
        plannedDates.sort((a, b) => new Date(a.plannedDate) - new Date(b.plannedDate));

        // Render sorted dates
        plannedDates.forEach(r => {
            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        <i class="bi bi-calendar-event text-danger me-2"></i>
                        ${formatDate(new Date(r.plannedDate))}
                    </span>
                    <span class="badge bg-secondary">
                        Route #${r.routeId}
                    </span>
                </li>`;
        });

        new bootstrap.Modal(document.getElementById("assignedModal")).show();
    }
    
    // Format multiple planned dates into readable ranges
    function formatPlannedDates(dates) {
        if (!dates || dates.length === 0) return "No planned routes";

        const sorted = dates.map(d => new Date(d)).sort((a,b) => a - b);
        const ranges = [];
        let start = sorted[0], prev = sorted[0];

        for (let i = 1; i < sorted.length; i++) {
            const curr = sorted[i];
            const diff = (curr - prev) / (1000*60*60*24);
            if (diff === 1) {
                prev = curr;
            } else {
                ranges.push(start === prev ? formatDate(start) : `${formatDate(start)} → ${formatDate(prev)}`);
                start = curr; prev = curr;
            }
        }
        ranges.push(start === prev ? formatDate(start) : `${formatDate(start)} → ${formatDate(prev)}`);
        return ranges.join(", ");
    }

    // Hook input changes to update calendar
    function parseLocalDate(value) {
        const [year, month, day] = value.split("-").map(Number);
        return new Date(year, month - 1, day); // month is 0-indexed
    }

    document.getElementById("dateFrom").addEventListener("change", function() {
        dateFrom = parseLocalDate(this.value);
        if (!dateTo || dateTo < dateFrom) dateTo = dateFrom;
        renderCalendar();
    });

    document.getElementById("dateTo").addEventListener("change", function() {
        dateTo = parseLocalDate(this.value);
        if (dateTo < dateFrom) dateFrom = dateTo;
        renderCalendar();
    });


    function updateHoverClasses() {
        document.querySelectorAll(".calendar-day").forEach(c => {
            const day = parseInt(c.innerText);
            const cellDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);

            // Skip weekends
            if (c.classList.contains("weekend")) return;

            c.classList.remove("selected");

            // Confirmed selection
            if (dateFrom && dateTo && cellDate >= stripTime(dateFrom) && cellDate <= stripTime(dateTo)) {
                c.classList.add("selected");
            }
            // Hover preview
            else if (dateFrom && !dateTo && hoverDate) {
                const start = stripTime(dateFrom);
                const end = stripTime(hoverDate);
                const minDate = start < end ? start : end;
                const maxDate = start > end ? start : end;
                if (cellDate >= minDate && cellDate <= maxDate) c.classList.add("selected");
            }
            // Single start-date
            else if (dateFrom && !dateTo && !hoverDate && isSameDay(cellDate, dateFrom)) {
                c.classList.add("selected");
            }
        });
    }

    // Initial setup
    const today = new Date();
    if (!dateFrom) dateFrom = today;
    if (!dateTo) dateTo = today;
    syncInputs();
    renderCalendar();
    loadAvailableOfficers();
</script>
}
