@model List<ADWebApplication.Models.RouteAssignment>

@{
    ViewData["Title"] = "Route History";
    Layout = "_Layout";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">
        <i class="bi bi-clock-history"></i> Collection Officer Route History - @ViewBag.OfficerFullName
    </h2>
</div>

<div class="d-flex align-items-center mb-3">
    <div class="input-group w-auto ms-auto">
        <span class="input-group-text">
            <i class="bi bi-search"></i>
        </span>
        <input type="text" id="searchBox" class="form-control" placeholder="Search..." onkeyup="filterTable()" />
    </div>
</div>


<table id="routeHistoryTable" class="table table-striped table-bordered align-middle">
    <thead class="table-primary">
        <tr>
            <th onclick="sortTable(0)"># <i class="bi bi-arrow-down-up"></i></th>
            <th onclick="sortTable(1)">Assigned Date <i class="bi bi-arrow-down-up"></i></th>
            <th onclick="sortTable(2)">Assigned By <i class="bi bi-arrow-down-up"></i></th>
            <th onclick="sortTable(3)">Route ID <i class="bi bi-arrow-down-up"></i></th>
            <th onclick="sortTable(4)">Route Date <i class="bi bi-arrow-down-up"></i></th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Any())
        {
            int count = 1;
            foreach (var assignment in Model)
            {
                <tr>
                    <td>@count</td>
                    <td>@assignment.AssignedDateTime.ToString("dd MMMM, yyyy")</td>
                    <td>
                        @if (assignment.AssignedByEmployee != null)
                        {
                            @assignment.AssignedByEmployee.FullName
                        }
                        else
                        {
                            @assignment.AssignedBy
                        }
                    </td>
                    <td>
                        @if (assignment.RoutePlans?.FirstOrDefault()?.RouteId != null)
                        {
                            @assignment.RoutePlans.FirstOrDefault().RouteId
                        }
                        else
                        {
                            @:N/A
                        }
                    </td>
                    <td>
                        @if (assignment.RoutePlans != null && assignment.RoutePlans.Any())
                        {
                            <ul>
                                @foreach (var routePlan in assignment.RoutePlans)
                                {
                                    <li>@(routePlan.PlannedDate?.ToString("dd MMMM, yyyy") ?? "-")</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <span class="text-muted">No route plans</span>
                        }
                    </td>
                </tr>
                count++;
            }
        }
        else
        {
            <tr>
                <td colspan="5" class="text-center text-muted">No route history found for this officer.</td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        // Client-side sorting function
        function sortTable(columnIndex) {
            var table = document.getElementById("routeHistoryTable");
            var rows = Array.from(table.tBodies[0].rows);
            var asc = table.getAttribute("data-sort-asc") === "true" ? false : true;

            rows.sort(function (a, b) {
                var aText = a.cells[columnIndex].innerText.trim();
                var bText = b.cells[columnIndex].innerText.trim();

                // If it's a date column, handle sorting accordingly
                if (columnIndex === 1 || columnIndex === 4) {
                    var aDate = new Date(aText);
                    var bDate = new Date(bText);
                    if (isNaN(aDate)) aDate = new Date(0);
                    if (isNaN(bDate)) bDate = new Date(0);
                    return (aDate - bDate) * (asc ? 1 : -1);
                }

                // For numeric columns like Route ID
                if (columnIndex === 0 || columnIndex === 3) {
                    var aNum = parseInt(aText);
                    var bNum = parseInt(bText);
                    return (aNum - bNum) * (asc ? 1 : -1);
                }

                // For text columns, do lexicographical sorting
                return (aText > bText ? 1 : aText < bText ? -1 : 0) * (asc ? 1 : -1);
            });

            for (var i = 0; i < rows.length; i++) {
                table.tBodies[0].appendChild(rows[i]);
            }

            table.setAttribute("data-sort-asc", asc);
        }

        // Search filter
        function filterTable() {
            var input = document.getElementById("searchBox");
            var filter = input.value.toLowerCase();
            var table = document.getElementById("routeHistoryTable");
            var rows = table.tBodies[0].rows;

            for (var i = 0; i < rows.length; i++) {
                rows[i].style.display = rows[i].innerText.toLowerCase().includes(filter) ? "" : "none";
            }
        }
    </script>
}